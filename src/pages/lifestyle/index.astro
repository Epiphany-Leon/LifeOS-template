---
// âœ… æ ¸å¿ƒä¿®å¤ 1ï¼šå¼ºåˆ¶å¼€å¯æœåŠ¡ç«¯å®æ—¶æ¸²æŸ“ï¼Œç¦æ­¢ Astro ç¼“å­˜ä»»ä½•æ—§æ•°æ®
export const prerender = false; 

import Layout from '../../layouts/Layout.astro';
import GlobalAlert from '../../components/GlobalAlert.astro';

const db = Astro.locals.runtime?.env?.DB;

let expensesList: any[] = [];
let monthlyBudget = 0;
let displayCurrency = 'CNY'; 
let spentTotal = 0;
let latestStress = 0; 
let variance = 0; 
let hasBudgetRecord = false;

let connectionsList: any[] = [];

// âœ… æ ¸å¿ƒä¿®å¤ 2ï¼šä¸¥æ ¼æ ¡å‡†æœ¬åœ°æ—¶åŒºï¼Œé˜²æ­¢è·¨æœˆé›¶ç‚¹æ—¶ç”±äºæ—¶åŒºå·®å¯¼è‡´çš„æœˆä»½åç§»
const now = new Date();
const localNow = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
const currentMonth = localNow.toISOString().substring(0, 7); // ç²¾ç¡®è·å– YYYY-MM

const exchangeRates: Record<string, number> = { CNY: 1, USD: 7.25, EUR: 7.82, GBP: 9.15, JPY: 0.048 };
const currencySymbols: Record<string, string> = { CNY: 'Â¥', USD: '$', EUR: 'â‚¬', GBP: 'Â£', JPY: 'Â¥' };

if (db) {
  // 1. ç‹¬ç«‹è·å–é¢„ç®—å¼•æ“ (ç»å¯¹é˜²å¾¡ï¼šå³ä½¿å…¶ä»–æŸ¥è¯¢å´©æºƒï¼Œé¢„ç®—ä¹Ÿèƒ½æ­£å¸¸è¯»å–)
  try {
    const bRes = await db.prepare("SELECT * FROM monthly_budgets WHERE month = ?").bind(currentMonth).all();
    if (bRes.results && bRes.results.length > 0) {
      hasBudgetRecord = true; // âœ… æˆåŠŸæ‹¦æˆªå¼¹çª—
      monthlyBudget = bRes.results[0].amount as number;
      displayCurrency = bRes.results[0].currency as string || 'CNY';
    }
  } catch (e) { console.error("Budget Fetch Error"); }

  // 2. ç‹¬ç«‹è·å–æµæ°´å¼•æ“
  try {
    const eRes = await db.prepare("SELECT * FROM expenses WHERE date LIKE ? ORDER BY date DESC, id DESC").bind(`${currentMonth}%`).all();
    expensesList = eRes.results || [];
    const baseRate = exchangeRates[displayCurrency] || 1;
    expensesList.forEach((exp: any) => {
       const expRate = exchangeRates[exp.currency as string] || 1;
       exp.convertedAmount = (exp.amount * expRate) / baseRate;
       if (exp.amount < 0) spentTotal += Math.abs(exp.convertedAmount);
    });
  } catch (e) { console.error("Expenses Fetch Error"); }

  // 3. ç‹¬ç«‹è·å–è§‰çŸ¥æ•°æ®
  try {
    const vRes = await db.prepare("SELECT stress_level FROM vitals ORDER BY date DESC LIMIT 1").all();
    if (vRes.results && vRes.results.length > 0) {
        latestStress = vRes.results[0].stress_level as number;
    }
  } catch (e) { console.error("Vitals Fetch Error"); }

  // 4. ç‹¬ç«‹è·å–ç¤¾äº¤å…³ç³»ç½‘
  try {
    const cRes = await db.prepare("SELECT * FROM connections ORDER BY closeness DESC, last_contact DESC").all();
    connectionsList = cRes.results || [];
  } catch (e) { console.error("Connections Fetch Error"); }
}

variance = monthlyBudget - spentTotal;
const isOverBudget = variance < 0;
const sym = currencySymbols[displayCurrency] || displayCurrency;
const percent = monthlyBudget > 0 ? Math.min((spentTotal/monthlyBudget)*100, 100) : 0;

// å…¨é‡ Category Icons å­—å…¸
const categoryIcons: Record<string, string> = {
  'é¤é¥®': 'ğŸ”', 'è´­ç‰©': 'ğŸ›ï¸', 'æ—¥ç”¨': 'ğŸ§º', 'äº¤é€š': 'ğŸš—', 'æ°´æœ': 'ğŸ', 'é›¶é£Ÿ': 'ğŸª', 'è¿åŠ¨': 'ğŸƒ', 'å¨±ä¹': 'ğŸ®', 'é€šè®¯': 'ğŸ“±', 'æœé¥°': 'ğŸ‘•',
  'ç¾å®¹': 'ğŸ’„', 'ä½æˆ¿': 'ğŸ ', 'å®¶åº­': 'ğŸ‘¨â€ğŸ‘©', 'ç¤¾äº¤': 'ğŸ¥‚', 'æ—…è¡Œ': 'âœˆï¸', 'æ•°ç ': 'ğŸ’»', 'æ±½è½¦': 'ğŸš˜', 'åŒ»ç–—': 'ğŸ¥', 'ä¹¦ç±': 'ğŸ“š', 'å­¦ä¹ ': 'ğŸ“',
  'å® ç‰©': 'ğŸ±', 'ç¤¼å“': 'ğŸ', 'åŠå…¬': 'ğŸ’¼', 'ç»´ä¿®': 'ğŸ› ï¸', 'å½©ç¥¨': 'ğŸ«', 'çº¢åŒ…': 'ğŸ§§', 'è¿˜æ¬¾': 'ğŸ’³', 'å€Ÿå‡º': 'ğŸ“¤', 'é¥®å“': 'ğŸ¥¤', 'è¿½æ˜Ÿ': 'ğŸŒŸ',
  'æ¸¸æˆ': 'ğŸ•¹ï¸', 'å¿«é€’': 'ğŸ“¦', 'æèµ ': 'ğŸ’–', 'ç¤¼é‡‘': 'ğŸ’°', 'çƒŸé…’': 'ğŸš¬', 'è”¬èœ': 'ğŸ¥¬', 'æŠ•èµ„': 'ğŸ“ˆ', 'å…¶ä»–': 'ğŸ“¦',
  'å·¥èµ„': 'ğŸ¦', 'ç§Ÿé‡‘': 'ğŸ—ï¸', 'åˆ†çº¢': 'ğŸ’¹', 'ç†è´¢': 'ğŸ“Š', 'å¹´ç»ˆå¥–': 'ğŸ†', 'å€Ÿå…¥': 'ğŸ“¥', 'æ”¶æ¬¾': 'ğŸ§¾'
};
---

<Layout title="Lifestyle - ç”Ÿæ´»ç»è¥">
  <GlobalAlert variance={variance} stress={latestStress} />

  <div class="fixed top-0 left-0 right-0 z-40 p-6 pointer-events-none">
    <div class="max-w-7xl mx-auto flex justify-end">
      <nav class="pointer-events-auto flex items-center gap-1 p-1.5 rounded-full bg-white/40 backdrop-blur-xl border border-white/50 shadow-lg ring-1 ring-white/60">
        <a href="/" class="px-4 py-2 rounded-full text-slate-600 font-medium hover:bg-white/30 transition-all text-sm">Dashboard</a>
        <a href="/execution" class="px-4 py-2 rounded-full text-slate-600 font-medium hover:bg-white/30 transition-all text-sm">Execution</a>
        <a href="/knowledge" class="px-4 py-2 rounded-full text-slate-600 font-medium hover:bg-white/30 transition-all text-sm">Knowledge</a>
        <a href="/lifestyle" class="px-5 py-2 rounded-full bg-white text-slate-800 font-semibold shadow-sm transition-all text-sm">Lifestyle</a>
        <a href="/vitals" class="px-4 py-2 rounded-full text-slate-600 font-medium hover:bg-white/30 transition-all text-sm">Vitals</a>
      </nav>
    </div>
  </div>

  <main class="max-w-7xl mx-auto p-6 lg:p-12 pt-40 pb-32">
    <header class="mb-10">
      <h1 class="text-4xl font-bold text-slate-800">ç”Ÿæ´»ç»è¥ Â· <span class="text-emerald-600">Lifestyle</span></h1>
      <p class="text-slate-500 mt-2 font-medium">å½“å‰è´¦æœŸ: {currentMonth.replace('-', 'å¹´')}æœˆ Â· æœ¬ä½å¸: {displayCurrency}</p>
      
      <div class="mt-8 flex bg-slate-100/80 backdrop-blur-md p-1.5 rounded-2xl border border-slate-200/50 shadow-inner w-fit">
          <button id="tabF" onclick="switchTab('finance')" class="px-8 py-2.5 rounded-xl text-sm font-bold bg-white text-emerald-600 shadow-sm transition-all flex items-center gap-2">
              <span>ğŸ’°</span> è´¢åŠ¡èµ„äº§
          </button>
          <button id="tabS" onclick="switchTab('social')" class="px-8 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:text-slate-700 transition-all flex items-center gap-2">
              <span>ğŸ¤</span> ç¤¾äº¤èµ„æœ¬
          </button>
      </div>
    </header>

    <div id="financeSection" class="block animate-in fade-in duration-500">
      <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-14">
        <div class="bg-white/60 backdrop-blur-xl border border-white p-7 rounded-[2.5rem] shadow-xl shadow-slate-200/50 flex flex-col min-h-[150px]">
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Monthly Budget</p>
          <div class="flex items-center gap-3">
            <span class="text-4xl font-black text-slate-800 tracking-tight" id="displayBudget">{sym}{monthlyBudget.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
            <button onclick="openBudgetModal()" class="p-1.5 rounded-full bg-slate-100 text-blue-500 hover:bg-blue-50 border border-slate-200 shadow-sm transition-all">
               <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
            </button>
          </div>
        </div>
        
        <div class="bg-white/60 backdrop-blur-xl border border-white p-7 rounded-[2.5rem] shadow-xl shadow-slate-200/50 flex flex-col min-h-[150px] relative overflow-hidden">
          <div class="flex-1">
              <div class="flex items-center gap-2 mb-4">
                  <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Actual Spent</p>
                  <span class="bg-slate-200/80 text-slate-600 px-1.5 py-0.5 rounded text-[8px] font-bold">{displayCurrency}</span>
              </div>
              <span class="text-4xl font-black text-slate-800 tracking-tight">{sym}{spentTotal.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
          </div>
          <div class="absolute right-8 top-7 bottom-7 w-2 bg-slate-100 rounded-full overflow-hidden border border-slate-50"><div class={`absolute bottom-0 left-0 right-0 transition-all duration-1000 ${variance < 0 ? 'bg-rose-500' : 'bg-emerald-500'}`} style={`height: ${percent}%`}></div></div>
        </div>

        <div class={`backdrop-blur-xl border p-7 rounded-[2.5rem] shadow-xl flex flex-col min-h-[150px] ${variance < 0 ? 'bg-rose-50/80 border-rose-100' : 'bg-emerald-50/80 border-emerald-100'}`}>
          <p class={`text-[10px] font-black uppercase tracking-widest mb-4 ${variance < 0 ? 'text-rose-400' : 'text-emerald-500'}`}>Variance</p>
          <span class={`text-4xl font-black tracking-tight ${variance < 0 ? 'text-rose-600' : 'text-emerald-600'}`}>{variance >= 0 ? '+' : ''}{sym}{variance.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
        </div>
      </section>

      <div class="flex justify-between items-center mb-6 border-b border-slate-200 pb-4">
        <h2 class="text-2xl font-bold text-slate-800">å½“æœˆæµæ°´ Archive</h2>
        <button onclick="openExpenseModal()" class="px-5 py-2 bg-slate-800 text-white rounded-full font-bold hover:bg-slate-700 transition text-sm">+ è®°å½•æµæ°´</button>
      </div>

      <div class="space-y-4">
        {expensesList.length > 0 ? expensesList.map(item => (
          <div class="bg-white border border-slate-100 p-5 rounded-[2rem] flex justify-between items-center group hover:border-slate-300 transition-all shadow-sm">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center text-xl border border-slate-100 shadow-sm">{categoryIcons[item.category] || 'ğŸ“¦'}</div>
              <div>
                <div class="font-bold text-slate-800 text-base">{item.description}</div>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-[9px] font-black uppercase tracking-wider text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md border border-slate-200">{item.category}</span>
                  <span class="text-xs font-mono text-slate-400">{item.date}</span>
                  {item.currency !== displayCurrency && <span class="text-[9px] text-slate-400 border border-slate-200 px-1.5 py-0.5 rounded bg-slate-50">åŸå€¼: {currencySymbols[item.currency]}{Math.abs(item.amount)}</span>}
                </div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                <button onclick={`openExpenseModal(${item.id}, ${item.amount}, '${item.currency}', '${item.category}', '${item.description}', '${item.date}')`} class="p-2 text-blue-500 hover:bg-blue-50 rounded-full bg-white shadow-sm border border-slate-200"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                <button onclick={`deleteExpense(${item.id})`} class="p-2 text-rose-500 hover:bg-rose-50 rounded-full bg-white shadow-sm border border-slate-200"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
              </div>
              <div class={`text-xl font-black w-28 text-right ${item.convertedAmount > 0 ? 'text-emerald-500' : 'text-slate-800'}`}>
                {item.convertedAmount > 0 ? '+' : '-'}{sym}{Math.abs(item.convertedAmount).toLocaleString('en-US', { maximumFractionDigits: 0 })}
              </div>
            </div>
          </div>
        )) : (
          <div class="p-16 text-center text-slate-400 border-2 border-dashed border-slate-200 bg-slate-50/50 rounded-[2.5rem] font-medium">å°šæœªå½•å…¥æµæ°´è®°å½•ã€‚</div>
        )}
      </div>
    </div>

    <div id="socialSection" class="hidden animate-in fade-in duration-500">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 border-b border-slate-200 pb-4">
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                <span class="w-2.5 h-6 bg-blue-500 rounded-full"></span> äººè„‰å›¾è°± CRM
            </h2>
            <div class="flex w-full md:w-auto gap-3">
                <div class="relative w-full md:w-72">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="connSearch" class="w-full pl-11 pr-4 py-2.5 rounded-full bg-white/60 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/30 text-slate-700 text-sm shadow-sm transition-all placeholder-slate-400" placeholder="æœç´¢å§“åæˆ–æ ¸å¿ƒç‰¹å¾...">
                </div>
                <button onclick="openConnModal()" class="px-5 py-2.5 bg-blue-600 text-white rounded-full font-bold shadow-md hover:bg-blue-500 active:scale-95 transition-all text-sm shrink-0 flex items-center gap-2">
                    <span>+</span> æ–°å¢èŠ‚ç‚¹
                </button>
            </div>
        </div>

        <div class="space-y-4 max-h-[700px] overflow-y-auto pr-2 custom-scrollbar">
            {connectionsList.map(conn => {
                const tagsArr = conn.tags ? conn.tags.split(',').map((t: string) => t.trim()).filter(Boolean) : [];
                return (
                    <div class="conn-card bg-white border border-slate-100 p-5 rounded-[2rem] flex flex-col md:flex-row justify-between items-start md:items-center group hover:border-slate-300 transition-all shadow-sm gap-4" data-search={`${conn.name} ${conn.tags} ${conn.details} ${conn.judgment}`.toLowerCase()}>
                        
                        <div class="flex items-center gap-4 flex-1 min-w-0">
                            <div class="w-12 h-12 rounded-2xl bg-blue-50 flex items-center justify-center text-xl border border-blue-100 shadow-sm shrink-0">ğŸ‘¤</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-bold text-slate-800 text-base truncate">{conn.name}</h3>
                                    <div class="flex gap-0.5">
                                        {[1,2,3,4,5].map(star => (
                                            <div class={`w-1.5 h-1.5 rounded-full ${star <= conn.closeness ? 'bg-amber-400' : 'bg-slate-200'}`}></div>
                                        ))}
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 mt-1 flex-wrap">
                                    {tagsArr.map((t: string) => (
                                        <span class="text-[9px] font-black uppercase tracking-wider text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md border border-blue-100">{t}</span>
                                    ))}
                                    <span class="text-[10px] font-mono text-slate-500 border border-slate-200 px-1.5 py-0.5 rounded bg-slate-50 flex items-center gap-1">ğŸ‚ {conn.birthday || '--'}</span>
                                </div>
                                <div class="text-xs text-slate-500 mt-2 line-clamp-1 leading-relaxed">
                                    {conn.details || 'æš‚æ— ç»†èŠ‚è®°å½•'} {conn.judgment ? <span class="text-indigo-500 font-bold ml-1">| ğŸ§  {conn.judgment}</span> : ''}
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-4 shrink-0 self-end md:self-auto">
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                <button onclick={`openConnModal(${conn.id}, '${conn.name}', '${conn.tags}', ${conn.closeness}, '${conn.last_contact}', '${(conn.details||'').replace(/'/g, "\\'")}', '${(conn.judgment||'').replace(/'/g, "\\'")}', '${conn.birthday||''}')`} class="p-2 text-blue-500 hover:bg-blue-50 rounded-full bg-white shadow-sm border border-slate-200">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                                <button onclick={`deleteConn(${conn.id})`} class="p-2 text-rose-500 hover:bg-rose-50 rounded-full bg-white shadow-sm border border-slate-200">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                            <div class="text-right w-24">
                                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Last Contact</div>
                                <div class="text-xs font-bold text-slate-700">{conn.last_contact || '--'}</div>
                            </div>
                        </div>
                    </div>
                );
            })}
            {connectionsList.length === 0 && (
                <div class="p-16 text-center text-slate-400 border-2 border-dashed border-slate-200 bg-slate-50/50 rounded-[2.5rem] font-medium">å°šæœªå½•å…¥äººè„‰èŠ‚ç‚¹ã€‚</div>
            )}
        </div>
    </div>
  </main>

  <div id="budgetModal" class="fixed inset-0 z-50 hidden items-center justify-center opacity-0 transition-opacity">
    <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeBudgetModal()"></div>
    <div class="relative bg-white/90 backdrop-blur-3xl p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm transform scale-95 transition-all">
      <h3 class="text-xl font-bold text-slate-800 mb-6">é…ç½® {currentMonth} é¢„ç®—</h3>
      <form id="budgetForm" class="space-y-4">
        <div><label class="block text-xs font-bold text-slate-500 mb-2">å…¨å±€æœ¬ä½å¸</label><select id="bCurrency" class="w-full px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-bold text-slate-700"><option value="CNY">CNY äººæ°‘å¸ (Â¥)</option><option value="USD">USD ç¾å…ƒ ($)</option><option value="EUR">EUR æ¬§å…ƒ (â‚¬)</option><option value="GBP">GBP è‹±é•‘ (Â£)</option><option value="JPY">JPY æ—¥å…ƒ (Â¥)</option></select></div>
        <div><label class="block text-xs font-bold text-slate-500 mb-2">é¢„ç®—é‡‘é¢</label><input type="number" id="bAmount" required class="w-full px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-black text-xl text-emerald-600"></div>
        <button type="submit" id="budgetSubmitBtn" class="w-full py-3.5 bg-emerald-500 text-white rounded-full font-bold shadow-lg shadow-emerald-500/30 active:scale-95 transition">ä¿å­˜é…ç½®</button>
      </form>
    </div>
  </div>

  <div id="expenseModal" class="fixed inset-0 z-50 hidden items-center justify-center opacity-0 transition-opacity">
    <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeExpenseModal()"></div>
    <div class="relative bg-white/90 backdrop-blur-3xl p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md transform scale-95 transition-all">
      <h3 id="eTitle" class="text-xl font-bold text-slate-800 mb-6">è®°å½•æµæ°´</h3>
      <form id="expenseForm" class="space-y-4">
        <input type="hidden" id="eId" value="">
        <div class="flex bg-slate-100 p-1.5 rounded-2xl font-bold text-sm mb-2">
          <label class="flex-1 cursor-pointer relative"><input type="radio" name="eType" value="expense" checked class="peer sr-only" onchange="toggleCategoryOptions('expense')"><div class="text-center py-2 rounded-xl peer-checked:bg-white peer-checked:text-rose-500 peer-checked:shadow-sm transition-all text-slate-400">æ”¯å‡º (-)</div></label>
          <label class="flex-1 cursor-pointer relative"><input type="radio" name="eType" value="income" class="peer sr-only" onchange="toggleCategoryOptions('income')"><div class="text-center py-2 rounded-xl peer-checked:bg-white peer-checked:text-emerald-500 peer-checked:shadow-sm transition-all text-slate-400">æ”¶å…¥ (+)</div></label>
        </div>
        <div class="grid grid-cols-3 gap-3"><select id="eCurrency" class="col-span-1 px-3 py-3 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-bold text-slate-700"><option value="CNY">CNY Â¥</option><option value="USD">USD $</option><option value="EUR">EUR â‚¬</option><option value="GBP">GBP Â£</option><option value="JPY">JPY Â¥</option></select><input type="number" id="eAmount" step="0.01" required class="col-span-2 px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-black text-lg" placeholder="0.00"></div>
        <div class="grid grid-cols-2 gap-3"><select id="eCategory" class="px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-bold text-sm text-slate-700"></select><input type="date" id="eDate" required class="px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200 outline-none text-sm font-bold text-slate-700"></div>
        <input type="text" id="eDesc" required class="w-full px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200 outline-none text-sm text-slate-700" placeholder="å¤‡æ³¨..."><button type="submit" class="w-full py-3.5 bg-slate-800 text-white rounded-full font-bold active:scale-95 transition shadow-lg mt-2">å½’æ¡£å…¥è´¦</button>
      </form>
    </div>
  </div>

  <div id="connModal" class="fixed inset-0 z-50 hidden items-center justify-center opacity-0 transition-opacity">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md" onclick="closeConnModal()"></div>
    <div class="relative bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-lg transform scale-95 transition-all">
      <h3 id="cTitle" class="text-2xl font-black text-slate-800 mb-6">äººè„‰èµ„äº§é…ç½®</h3>
      <form id="connForm" class="space-y-4">
        <input type="hidden" id="cId">
        <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">å§“å</label><input type="text" id="cName" required class="w-full px-4 py-3 rounded-2xl bg-slate-50 border border-slate-100 outline-none font-bold"></div>
            <div><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">ç”Ÿæ—¥ (å«å†œå†)</label><input type="text" id="cBirthday" class="w-full px-4 py-3 rounded-2xl bg-slate-50 border border-slate-100 outline-none font-bold" placeholder="ä¾‹: 10-15 æˆ– å†œå†è…Šæœˆåˆå…«"></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">äº²å¯†åº¦ (0-5)</label><select id="cCloseness" class="w-full px-4 py-3 rounded-2xl bg-slate-50 border border-slate-100 outline-none font-bold text-amber-500"><option value="0">â˜†â˜†â˜†â˜†â˜† (0)</option><option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option><option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option><option value="3" selected>â˜…â˜…â˜…â˜†â˜† (3)</option><option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option><option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option></select></div>
            <div><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">ä¸Šæ¬¡è”ç³»</label><input type="date" id="cDate" class="w-full px-4 py-3 rounded-2xl bg-slate-50 border border-slate-100 outline-none text-xs font-bold"></div>
        </div>
        <div><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">æ ‡ç­¾ (Tags)</label><input type="text" id="cTags" class="w-full px-4 py-3 rounded-2xl bg-slate-50 border border-slate-100 outline-none text-xs font-bold" placeholder="æ ¡å‹, äº²æˆš, è¡Œä¸šå¤§ä½¬..."></div>
        <div><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">ç»†èŠ‚ç‰¹å¾ (Details)</label><textarea id="cDetails" rows="2" class="w-full px-4 py-3 rounded-2xl bg-slate-50 border border-slate-100 outline-none text-xs resize-none" placeholder="è®°å½•ä»–çš„ç‰¹å¾ç‚¹ã€è®°å¿†ç‚¹..."></textarea></div>
        <div><label class="block text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">ä¸»è§‚ç ”åˆ¤ (Judgment)</label><textarea id="cJudgment" rows="2" class="w-full px-4 py-3 rounded-2xl bg-indigo-50 border border-indigo-100 outline-none text-xs resize-none" placeholder="åˆä½œä¿¡ä»»åº¦æˆ–é•¿æœŸå…³ç³»åˆ¤æ–­..."></textarea></div>
        <button type="submit" class="w-full py-4 bg-slate-800 text-white rounded-full font-black shadow-xl active:scale-95 transition-all">åŒæ­¥è‡³äººè„‰å›¾è°±</button>
      </form>
    </div>
  </div>
</Layout>

<script is:inline define:vars={{ currentMonth, displayCurrency, monthlyBudget, categoryIcons, hasBudgetRecord }}>
  // --- Tab åˆ‡æ¢ ---
  window.switchTab = (tab) => {
      const tabF = document.getElementById('financeSection'), tabS = document.getElementById('socialSection');
      const btnF = document.getElementById('tabF'), btnS = document.getElementById('tabS');
      if (tab === 'finance') {
          tabS.classList.add('hidden'); tabF.classList.remove('hidden');
          btnF.className = "px-10 py-2.5 rounded-xl text-sm font-bold bg-white text-emerald-600 shadow-sm transition-all flex items-center gap-2";
          btnS.className = "px-10 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:text-slate-700 transition-all flex items-center gap-2";
      } else {
          tabF.classList.add('hidden'); tabS.classList.remove('hidden');
          btnS.className = "px-10 py-2.5 rounded-xl text-sm font-bold bg-white text-blue-600 shadow-sm transition-all flex items-center gap-2";
          btnF.className = "px-10 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:text-slate-700 transition-all flex items-center gap-2";
      }
  };

  // --- Connections æœç´¢ä¸é€»è¾‘ ---
  document.getElementById('connSearch')?.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      document.querySelectorAll('.conn-card').forEach(card => {
          card.style.display = card.dataset.search.includes(term) ? 'flex' : 'none';
      });
  });

  const cModal = document.getElementById('connModal'), cForm = document.getElementById('connForm');
  window.openConnModal = (id=null, name='', tags='', closeness=0, date=null, details='', judgment='', birthday='') => {
      document.getElementById('cTitle').innerText = id ? 'æ›´æ–°äººè„‰å›¾è°±' : 'äººè„‰èµ„äº§é…ç½®';
      document.getElementById('cId').value = id || '';
      document.getElementById('cName').value = name;
      document.getElementById('cTags').value = tags;
      document.getElementById('cCloseness').value = closeness;
      document.getElementById('cDate').value = date || new Date().toISOString().slice(0,10);
      document.getElementById('cDetails').value = details;
      document.getElementById('cJudgment').value = judgment;
      document.getElementById('cBirthday').value = birthday;
      cModal.classList.remove('hidden'); cModal.classList.add('flex'); void cModal.offsetWidth;
      cModal.classList.remove('opacity-0'); cModal.querySelector('.relative').classList.remove('scale-95');
  };
  window.closeConnModal = () => { cModal.classList.add('opacity-0'); cModal.querySelector('.relative').classList.add('scale-95'); setTimeout(() => { cModal.classList.add('hidden'); cModal.classList.remove('flex'); }, 300); };
  
  cForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('cId').value;
      const data = {
          name: document.getElementById('cName').value, tags: document.getElementById('cTags').value, closeness: parseInt(document.getElementById('cCloseness').value),
          last_contact: document.getElementById('cDate').value, details: document.getElementById('cDetails').value, judgment: document.getElementById('cJudgment').value, birthday: document.getElementById('cBirthday').value
      };
      await fetch(id ? `/api/connections/${id}` : '/api/connections', { method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      window.location.reload();
  });
  window.deleteConn = async (id) => { if(confirm('ç¡®è®¤å°†æ­¤èŠ‚ç‚¹ç§»å‡ºäººè„‰åº“ï¼Ÿ')) { await fetch(`/api/connections/${id}`, { method: 'DELETE' }); window.location.reload(); } };

  // --- è´¢åŠ¡é¢„ç®—é€»è¾‘ ---
  const bm = document.getElementById('budgetModal'), em = document.getElementById('expenseModal'), eCategorySelect = document.getElementById('eCategory');
  
  // å®Œæ•´ä¿ç•™åˆ†ç±»å­—å…¸
  const categories = { 
      expense: ['é¤é¥®', 'è´­ç‰©', 'æ—¥ç”¨', 'äº¤é€š', 'æ°´æœ', 'é›¶é£Ÿ', 'è¿åŠ¨', 'å¨±ä¹', 'é€šè®¯', 'æœé¥°', 'ç¾å®¹', 'ä½æˆ¿', 'å®¶åº­', 'ç¤¾äº¤', 'æ—…è¡Œ', 'æ•°ç ', 'æ±½è½¦', 'åŒ»ç–—', 'ä¹¦ç±', 'å­¦ä¹ ', 'å® ç‰©', 'ç¤¼å“', 'åŠå…¬', 'ç»´ä¿®', 'å½©ç¥¨', 'çº¢åŒ…', 'è¿˜æ¬¾', 'å€Ÿå‡º', 'é¥®å“', 'è¿½æ˜Ÿ', 'æ¸¸æˆ', 'å¿«é€’', 'æèµ ', 'ç¤¼é‡‘', 'çƒŸé…’', 'è”¬èœ', 'æŠ•èµ„', 'å…¶ä»–'], 
      income: ['å·¥èµ„', 'çº¢åŒ…', 'ç§Ÿé‡‘', 'åˆ†çº¢', 'ç†è´¢', 'å¹´ç»ˆå¥–', 'å€Ÿå…¥', 'æ”¶æ¬¾', 'å…¶ä»–'] 
  };
  window.toggleCategoryOptions = (type) => { eCategorySelect.innerHTML = categories[type].map(cat => `<option value="${cat}">${categoryIcons[cat] || 'ğŸ“¦'} ${cat}</option>`).join(''); };
  
  window.openBudgetModal = () => { document.getElementById('bAmount').value = monthlyBudget || ''; document.getElementById('bCurrency').value = displayCurrency; bm.classList.remove('hidden'); bm.classList.add('flex'); void bm.offsetWidth; bm.classList.remove('opacity-0'); bm.querySelector('.relative').classList.remove('scale-95'); };
  window.closeBudgetModal = () => { bm.classList.add('opacity-0'); bm.querySelector('.relative').classList.add('scale-95'); setTimeout(() => { bm.classList.add('hidden'); bm.classList.remove('flex'); }, 300); };
  
  // âœ… å®Œç¾é˜»å‡»å¼¹çª—æ­»å¾ªç¯ï¼šåªåœ¨æ²¡æœ‰è®°å½•æ—¶å¼¹çª—
  document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => { if (!hasBudgetRecord) window.openBudgetModal(); }, 1000);
  });

  // âœ… é¢„ç®—ä¿å­˜å›è°ƒä¿®å¤
  document.getElementById('budgetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('budgetSubmitBtn');
    btn.disabled = true; btn.innerText = 'ä¿å­˜ä¸­...';
    try {
        const res = await fetch('/api/budgets', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ month: currentMonth, amount: parseFloat(document.getElementById('bAmount').value), currency: document.getElementById('bCurrency').value }) });
        const data = await res.json();
        if(data.success) {
            window.location.reload(); 
        } else {
            alert('é¢„ç®—ä¿å­˜å¤±è´¥: ' + (data.error || 'æ•°æ®åº“å¼‚å¸¸'));
            btn.disabled = false; btn.innerText = 'ä¿å­˜é…ç½®';
        }
    } catch(err) { alert('ç½‘ç»œè¯·æ±‚å¤±è´¥'); btn.disabled = false; btn.innerText = 'ä¿å­˜é…ç½®'; }
  });

  window.openExpenseModal = (id=null, amt='', curr=displayCurrency, cat='', desc='', date=null) => { 
      document.getElementById('eTitle').innerText = id ? 'ç¼–è¾‘æµæ°´' : 'è®°å½•æµæ°´'; 
      document.getElementById('eId').value = id || ''; 
      const type = (amt !== '' && Number(amt) > 0) ? 'income' : 'expense'; 
      document.querySelector(`input[name="eType"][value="${type}"]`).checked = true; 
      toggleCategoryOptions(type); 
      if(amt !== '') { document.getElementById('eAmount').value = Math.abs(amt); document.getElementById('eCategory').value = cat; } 
      document.getElementById('eCurrency').value = curr; 
      document.getElementById('eDesc').value = desc; 
      document.getElementById('eDate').value = date || new Date().toISOString().slice(0,10); 
      em.classList.remove('hidden'); em.classList.add('flex'); void em.offsetWidth; em.classList.remove('opacity-0'); em.querySelector('.relative').classList.remove('scale-95'); 
  };
  window.closeExpenseModal = () => { em.classList.add('opacity-0'); em.querySelector('.relative').classList.add('scale-95'); setTimeout(() => { em.classList.add('hidden'); em.classList.remove('flex'); }, 300); };
  
  document.getElementById('expenseForm').addEventListener('submit', async (e) => { e.preventDefault(); const id = document.getElementById('eId').value; const isIncome = document.querySelector('input[name="eType"]:checked').value === 'income'; let amt = parseFloat(document.getElementById('eAmount').value); if (!isIncome) amt = -Math.abs(amt); const payload = { amount: amt, currency: document.getElementById('eCurrency').value, category: eCategorySelect.value, description: document.getElementById('eDesc').value, date: document.getElementById('eDate').value }; await fetch(id ? `/api/expenses/${id}` : '/api/expenses', { method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); window.location.reload(); });
  window.deleteExpense = async (id) => { if(confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) { await fetch(`/api/expenses/${id}`, { method: 'DELETE' }); window.location.reload(); } };
</script>

<style is:global>
  .custom-scrollbar::-webkit-scrollbar { width: 5px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.1); border-radius: 10px; }
</style>